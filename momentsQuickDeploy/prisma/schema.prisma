generator client {
  provider = "prisma-client-js"
  // output   = "../src/generated/prisma"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model article_guest_likes {
  guest_id   String   @db.VarChar(255) /// 游客的唯一标识符 (例如 UUID)
  article_id BigInt   @db.UnsignedBigInt /// 被点赞的文章ID
  ip_address String   @db.VarChar(45) /// 点赞时用户的IP地址
  created_at DateTime @default(now()) /// 点赞时间

  article articles @relation(fields: [article_id], references: [id], onDelete: Cascade)

  @@id([guest_id, article_id]) // 联合主键，防止同一游客重复点赞
  @@index([article_id])
}

model article_likes {
  user_id    BigInt   @db.UnsignedBigInt
  article_id BigInt   @db.UnsignedBigInt
  created_at DateTime @default(now()) @db.Timestamp(0)
  article    articles @relation(fields: [article_id], references: [id], onDelete: Cascade, map: "fk_likes_article")
  user       users    @relation(fields: [user_id], references: [id], onDelete: Cascade, map: "fk_likes_user")

  @@id([user_id, article_id])
  @@index([article_id], map: "fk_likes_article")
}

model articles {
  id                  BigInt                @id @default(autoincrement()) @db.UnsignedBigInt
  user_id             BigInt                @db.UnsignedBigInt
  content             String                @db.Text
  type                Int                   @default(0) @db.UnsignedTinyInt // 文章类型 (0:文字, 1:图片, 2:视频)
  is_top              Boolean               @default(false) // 是否置顶
  is_ad               Boolean               @default(false) // 是否广告
  location            String?               @db.VarChar(50)
  status              Int                   @default(0) @db.UnsignedTinyInt
  like_count          Int                   @default(0) @db.UnsignedInt
  comment_count       Int                   @default(0) @db.UnsignedInt
  published_at        DateTime?             @db.Timestamp(0)
  created_at          DateTime              @default(now()) @db.Timestamp(0)
  updated_at          DateTime              @default(now()) @updatedAt @db.Timestamp(0)
  deleted_at          DateTime?             @db.Timestamp(0)
  // 关系字段（一篇文章属于一个用户），指向users的关系
  user                users                 @relation(fields: [user_id], references: [id], onDelete: Cascade, map: "fk_articles_user")
  // 反向关系字段（一篇文章可以有多个评论、喜欢）
  article_images      article_images[]
  article_videos      article_videos[]
  comments            comments[]
  article_likes       article_likes[]
  article_guest_likes article_guest_likes[]

  @@index([is_top, published_at])
  @@index([is_ad])
  @@index([status, published_at], map: "idx_status_published")
  @@index([user_id], map: "idx_user_id")
}

model article_images {
  id         BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  article_id BigInt   @db.UnsignedBigInt
  image_url  String   @db.VarChar(255)
  sort_order Int      @default(0) @db.UnsignedTinyInt
  created_at DateTime @default(now())

  article_images articles @relation(fields: [article_id], references: [id], onDelete: Cascade)

  @@index([article_id])
}

model article_videos {
  id            BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  article_id    BigInt   @db.UnsignedBigInt
  video_url     String   @db.VarChar(255)
  thumbnail_url String?  @db.VarChar(255) // 视频封面
  duration      Int? //视频时长
  sort_order    Int      @default(0) @db.UnsignedTinyInt
  created_at    DateTime @default(now())

  article_videos articles @relation(fields: [article_id], references: [id], onDelete: Cascade)

  @@index([article_id])
}

model comments {
  id         BigInt     @id @default(autoincrement()) @db.UnsignedBigInt
  article_id BigInt     @db.UnsignedBigInt
  user_id    BigInt     @db.UnsignedBigInt
  parent_id  BigInt?    @db.UnsignedBigInt
  content    String     @db.Text
  created_at DateTime   @default(now()) @db.Timestamp(0)
  updated_at DateTime   @default(now()) @updatedAt @db.Timestamp(0)
  deleted_at DateTime?  @db.Timestamp(0)
  // 关系字段
  article    articles   @relation(fields: [article_id], references: [id], onDelete: Cascade, map: "fk_comments_article")
  parent     comments?  @relation("commentsTocomments", fields: [parent_id], references: [id], onDelete: Cascade, map: "fk_comments_parent")
  replies    comments[] @relation("commentsTocomments")
  user       users      @relation(fields: [user_id], references: [id], onDelete: Cascade, map: "fk_comments_user")

  @@index([article_id], map: "idx_article_id")
  @@index([parent_id], map: "idx_parent_id")
  @@index([user_id], map: "idx_user_id")
}

model logs {
  id          BigInt   @id @default(autoincrement()) @db.UnsignedBigInt
  user_id     BigInt?  @db.UnsignedBigInt
  action      String   @db.VarChar(50)
  target_type String?  @db.VarChar(50)
  target_id   BigInt?  @db.UnsignedBigInt
  details     Json?
  ip_address  String?  @db.VarChar(45)
  user_agent  String?  @db.Text
  status      String   @default("SUCCESS") @db.VarChar(20)
  created_at  DateTime @default(now()) @db.Timestamp(0)
  user        users?   @relation(fields: [user_id], references: [id], onDelete: NoAction, map: "fk_logs_user")

  @@index([action], map: "idx_action")
  @@index([created_at], map: "idx_created_at")
  @@index([target_type, target_id], map: "idx_target")
  @@index([user_id], map: "idx_user_id")
}

// 用户表
model users {
  id                BigInt          @id @default(autoincrement()) @db.UnsignedBigInt
  username          String          @unique(map: "uk_username") @db.VarChar(30)
  password          String          @db.VarChar(255)
  nickname          String?         @db.VarChar(50)
  brief             String?         @db.VarChar(255)
  role              Int             @default(0) @db.UnsignedTinyInt
  status            Int             @default(0) @db.UnsignedTinyInt // 0未激活 | 1正常 | 2封禁
  banned_until      DateTime? // null表示未封禁
  email             String?         @unique(map: "uk_email") @db.VarChar(120)
  header_background String?         @db.VarChar(255)
  avatar            String?         @db.VarChar(255)
  created_at        DateTime        @default(now()) @db.Timestamp(0)
  updated_at        DateTime        @default(now()) @updatedAt @db.Timestamp(0)
  deleted_at        DateTime?       @db.Timestamp(0)
  // 反向关系
  article_likes     article_likes[]
  articles          articles[]
  comments          comments[]
  logs              logs[]

  @@index([status], map: "idx_status")
}
