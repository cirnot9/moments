import{H as U,B as j}from"./Brief-C8N44YP5.js";import{A as E}from"./ArticleItem-HVwc2niC.js";import{e as G,f as v,u as q,g as V,h as O,i as J,j as K,c as y,a as z,k as N,F as Q,l as W,m as h,o as k,b as C,_ as R}from"./index-DC8TisQv.js";import{g as x,a as X,b as Y,c as B,l as P,d as F}from"./articles-kPCKrvUi.js";import{g as D,c as Z}from"./comments-CCeL1_DB.js";import"./UserCircleRegular-BCEMIIOK.js";import"./time-Pdvgg59k.js";import"./location-Bpxr3BpU.js";const m=V(),M=q(),H=v({}),g=v({}),I=G("feed",()=>{const l=v([]),r=v(0),s=v(!1),f=v(!0),o=v({}),w=async e=>{try{if(!l.value.find(a=>a.id===e)){const a=M.token?void 0:x(),d=await X(e,a);l.value.push(d.data)}}catch(t){console.error(`获取文章 ${e}失败`,t)}},_=async e=>{try{const t=await Y(e);H.value[e]=t.data}catch(t){console.error(`获取文章 ${e} 的点赞人列表失败:`,t)}},S=async()=>{s.value=!0;try{const e=M.token?void 0:x(),t=await B({page:1,pageSize:5},e);return l.value=t.data.data,r.value=1,f.value=l.value.length<t.data.total,!0}catch(e){return console.error("获取初始文章失败：",e),!1}finally{s.value=!1}},A=async()=>{if(s.value||!f.value)return{status:0};s.value=!0;try{const e=r.value+1,t=M.token?void 0:x(),a=await B({page:e,pageSize:5},t);if(a.data.data.length>0){const d=new Set(l.value.map(u=>u.id)),n=a.data.data.filter(u=>!d.has(u.id));return l.value.push(...n),r.value+=1,f.value=l.value.length<a.data.total,{status:1}}}catch(e){return console.error("获取更多文章失败:",e),{status:2,error:e}}finally{s.value=!1}},b=async e=>{const t=l.value.find(u=>u.id===e);if(!t){console.error(`未在 Store 中找到 ID 为 ${e} 的文章`);return}const a=t.isLiked,d=t.like_count;a?(t.isLiked=!1,t.like_count--):(t.isLiked=!0,t.like_count++);const n=v(1);try{if(M.token)return t.isLiked?(n.value=m.show("正在点赞","loading"),await P(e),m.update(n.value,{text:"点赞成功",type:"success",duration:2e3})):(n.value=m.show("正在取消点赞","loading"),await F(e),m.update(n.value,{text:"取消点赞成功",type:"success",duration:2e3})),await _(e),!0;{const u=x();t.isLiked?(n.value=m.show("正在点赞","loading"),await P(e,u),m.update(n.value,{text:"点赞成功",type:"success",duration:2e3})):(n.value=m.show("正在取消点赞","loading",2e3),await F(e,u),m.update(n.value,{text:"取消点赞成功",type:"success",duration:2e3}))}return!0}catch(u){return console.error(`为文章 ${e} 更新点赞状态失败：`,u),t.isLiked=a,t.like_count=d,u.response.status===429?n.value!==null?(m.update(n.value,{text:"操作过于频繁，请稍后重试",type:"error",duration:2e3}),!1):(console.error("id 变量为 null，无法传递给函数"),m.update(n.value,{text:"操作过于频繁，请稍后重试",type:"error",duration:2e3}),!1):(m.update(n.value,{text:"操作失败，请稍后重试",type:"error",duration:2e3}),!1)}};function L(e,t){const a=g.value[e]?.length||0;o.value[e].hasMore=a<t,o.value[e].remaining=t-a}return{articles:l,isLoading:s,hasMore:f,fetchInitialArticles:S,fetchMoreArticles:A,toggleLike:b,fetchInitialComments:async e=>{const t=o.value[e];if(!(t?.isLoading||t?.page>0)){o.value[e]={page:1,pageSize:3,total:0,hasMore:!0,isLoading:!0,remaining:0};try{const a=await D(Number(e),{page:1,pageSize:o.value[e].pageSize});return g.value[e]=a.data.data,o.value[e].total=a.data.total,L(Number(e),a.data.total),!0}catch(a){return console.error("获取初始评论失败：",a),!1}finally{o.value[e].isLoading=!1}}},fetchMoreComments:async e=>{const t=o.value[e];if(!(!t||t.isLoading||!t.hasMore)){o.value[e].isLoading=!0;try{const a=t.page+1,d=t.pageSize,n=await D(e,{page:a,pageSize:d});g.value[e]||(g.value[e]=[]);const u=new Set(g.value[e]?.map($=>$.id)),T=n.data.data.filter($=>!u.has($.id));return g.value[e].push(...T),o.value[e].page=a,L(e,n.data.total),!0}catch(a){return console.error("获取更多更多评论失败：",a),!1}finally{o.value[e].isLoading=!1}}},commentPagination:o,commentsMap:g,createComment:async e=>{try{const t=await Z(e);if(t.data){const a=t.data;g.value[e.articleId]||(g.value[e.articleId]=[]),g.value[e.articleId].push(a);const d=l.value.find(n=>n.id===Number(e.articleId));d&&d.comment_count++}return!0}catch(t){return console.error("创建评论失败：",t),!1}},fetchArticleLikers:_,articleLikesMap:H,fetchSingleArticle:w}}),ee={class:"article-container"},te={key:0,class:"status-indicator"},se={key:1,class:"status-indicator"},ae=O({__name:"ArticleList",setup(l){const r=V(),s=I(),f=v(null);let o=null;const w=v({}),_=async i=>{for(const p of i)s.articleLikesMap[p.id]||await s.fetchArticleLikers(p.id),s.commentsMap[p.id]||await s.fetchInitialComments(p.id)};J(async()=>{const i=r.show("正在加载文章","loading");await s.fetchInitialArticles()?(await _(s.articles),r.update(i,{type:"success",text:"文章加载成功",duration:2e3})):r.update(i,{type:"error",text:"文章加载失败",duration:2e3}),o=new IntersectionObserver(async c=>{if(c[0].isIntersecting){console.log("滚动到底部，加载更多...");const e=r.show("正在加载文章","loading"),t=s.articles.length,a=await s.fetchMoreArticles();if(a?.status===0)r.update(e,{type:"info",text:"没有更多文章了",duration:2e3});else if(a?.status===1){const d=s.articles.slice(t);await _(d),r.update(e,{type:"success",text:"文章加载成功",duration:2e3})}else r.update(e,{type:"error",text:"文章加载失败",duration:2e3})}},{rootMargin:"0px 0px 10px 0px"}),f.value&&o.observe(f.value)}),K(()=>{o&&f.value&&o.unobserve(f.value)});function S(i){s.toggleLike(i)}function A(i){w.value[i]=!w.value[i]}async function b(i){const p=r.show("正在创建评论","loading");await s.createComment(i)?r.update(p,{type:"success",text:"评论成功",duration:2e3}):r.update(p,{type:"error",text:"评论失败",duration:2e3})}function L(i){s.fetchMoreComments(i)}return(i,p)=>(k(),y("div",ee,[z("ul",null,[(k(!0),y(Q,null,W(h(s).articles,c=>(k(),y("li",{key:c.id},[C(E,{article:c,likers:h(s).articleLikesMap[c.id]||[],comments:h(s).commentsMap[c.id]||[],"is-show-input":!!w.value[c.id],"has-more-comments":h(s).commentPagination[c.id]?.hasMore??!1,"remaining-comments":h(s).commentPagination[c.id]?.remaining??0,"is-loading-comments":h(s).commentPagination[c.id]?.isLoading??!1,onLike:S,onComment:()=>A(c.id),onSendReply:b,onLoadMoreComments:()=>L(c.id)},null,8,["article","likers","comments","is-show-input","has-more-comments","remaining-comments","is-loading-comments","onComment","onLoadMoreComments"])]))),128))]),z("div",{ref_key:"scrollTrigger",ref:f,class:"scroll-trigger"},null,512),h(s).isLoading?(k(),y("div",te," 正在加载中... ")):N("",!0),!h(s).hasMore&&h(s).articles.length>0?(k(),y("div",se," - 没有更多了 - ")):N("",!0)]))}}),ne=R(ae,[["__scopeId","data-v-becd95c6"]]),oe={class:"container"},re=O({__name:"Index",setup(l){return(r,s)=>(k(),y("div",oe,[C(U),C(j),C(ne)]))}}),ge=R(re,[["__scopeId","data-v-d759021b"]]);export{ge as default};
